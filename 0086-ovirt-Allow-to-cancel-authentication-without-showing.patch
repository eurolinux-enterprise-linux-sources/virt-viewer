From a1a1b20a25d0e545d215804f713644c2299e30b1 Mon Sep 17 00:00:00 2001
From: Pavel Grunt <pgrunt@redhat.com>
Date: Mon, 16 Mar 2015 11:20:02 +0100
Subject: [PATCH virt-viewer] ovirt: Allow to cancel authentication without
 showing error dialog

Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=1318575
---
 configure.ac        | 13 ++++++++++++-
 src/remote-viewer.c | 12 ++++++++++++
 2 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index 4adb58d..9784a43 100644
--- a/configure.ac
+++ b/configure.ac
@@ -203,7 +203,18 @@ AS_IF([test "x$with_ovirt" != "xno"],
       [have_ovirt=no])
 
 AS_IF([test "x$have_ovirt" = "xyes"],
-      [AC_DEFINE([HAVE_OVIRT], 1, [Have libgovirt?])],
+      [AC_DEFINE([HAVE_OVIRT], 1, [Have libgovirt?])]
+      [SAVED_CFLAGS="$CFLAGS"
+       SAVED_LIBS="$LIBS"
+       CFLAGS="$OVIRT_CFLAGS"
+       LIBS="$OVIRT_LIBS"
+       AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <govirt/govirt.h>]],
+        [static int err = OVIRT_REST_CALL_ERROR_CANCELLED;
+         void *fun = rest_proxy_auth_cancel;])],
+        [AC_DEFINE([HAVE_OVIRT_CANCEL], 1, [Have rest_proxy_auth_cancel and OVIRT_REST_CALL_ERROR_CANCELLED?])],
+        [])
+       CFLAGS="$SAVED_CFLAGS"
+       LIBS="$SAVED_LIBS"],
       [AS_IF([test "x$with_ovirt" = "xyes"],
              [AC_MSG_ERROR([oVirt support requested but libgovirt not found])
       ])
diff --git a/src/remote-viewer.c b/src/remote-viewer.c
index 418f6e7..978e881 100644
--- a/src/remote-viewer.c
+++ b/src/remote-viewer.c
@@ -729,6 +729,10 @@ authenticate_cb(RestProxy *proxy, G_GNUC_UNUSED RestProxyAuth *auth,
                      "username", username,
                      "password", password,
                      NULL);
+#ifdef HAVE_OVIRT_CANCEL
+    } else {
+        rest_proxy_auth_cancel(auth);
+#endif
     }
 
     g_free(username);
@@ -863,6 +867,14 @@ create_ovirt_session(VirtViewerApp *app, const char *uri, GError **err)
     api = ovirt_proxy_fetch_api(proxy, &error);
     if (error != NULL) {
         g_debug("failed to get oVirt 'api' collection: %s", error->message);
+#ifdef HAVE_OVIRT_CANCEL
+        if (g_error_matches(error, OVIRT_REST_CALL_ERROR, OVIRT_REST_CALL_ERROR_CANCELLED)) {
+            g_clear_error(&error);
+            g_set_error_literal(&error,
+                                VIRT_VIEWER_ERROR, VIRT_VIEWER_ERROR_CANCELLED,
+                                _("Authentication was cancelled"));
+        }
+#endif
         goto error;
     }
     vms = ovirt_api_get_vms(api);
