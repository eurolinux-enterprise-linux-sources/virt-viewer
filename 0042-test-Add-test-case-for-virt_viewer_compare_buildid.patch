From 9b976f34a414740aa966b7373930e8c17e28bd76 Mon Sep 17 00:00:00 2001
From: Christophe Fergeau <cfergeau@redhat.com>
Date: Wed, 20 May 2015 13:29:11 +0200
Subject: [PATCH] test: Add test case for virt_viewer_compare_buildid

---
 src/Makefile.am            | 20 ++++++++++++++++
 src/test-version-compare.c | 59 ++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 79 insertions(+)
 create mode 100644 src/test-version-compare.c

diff --git a/src/Makefile.am b/src/Makefile.am
index e76da2c..b8dbb35 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -75,6 +75,26 @@ COMMON_SOURCES +=					\
 	ovirt-foreign-menu.h ovirt-foreign-menu.c
 endif
 
+check_PROGRAMS = test-version-compare
+TESTS = $(check_PROGRAMS)
+test_version_compare_SOURCES =				\
+	virt-viewer-util.c				\
+	virt-viewer-util.h				\
+	test-version-compare.c				\
+	$(NULL)
+test_version_compare_LDFLAGS =			\
+	$(GLIB2_LIBS)				\
+	$(GTK_LIBS)				\
+	$(LIBXML2_LIBS)				\
+	$(NULL)
+test_version_compare_CFLAGS =			\
+	-DLOCALE_DIR=\""$(datadir)/locale"\"	\
+	$(GLIB2_CFLAGS) 			\
+	$(GTK_CFLAGS)				\
+	$(LIBXML2_CFLAGS)			\
+	$(WARN_CFLAGS)				\
+	$(NULL)
+
 if HAVE_LIBVIRT
 bin_PROGRAMS += virt-viewer
 virt_viewer_SOURCES =					\
diff --git a/src/test-version-compare.c b/src/test-version-compare.c
new file mode 100644
index 0000000..0377f7e
--- /dev/null
+++ b/src/test-version-compare.c
@@ -0,0 +1,59 @@
+/* -*- Mode: C; c-basic-offset: 4; indent-tabs-mode: nil -*- */
+/*
+ * Virt Viewer: A virtual machine console viewer
+ *
+ * Copyright (C) 2015 Red Hat, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
+ */
+#include <glib.h>
+#include <virt-viewer-util.h>
+
+gboolean doDebug = FALSE;
+
+int main(void)
+{
+    g_assert(virt_viewer_compare_buildid("1-1", "1-1") == 0);
+    g_assert(virt_viewer_compare_buildid("1-1", "1-1.1") < 0);
+    g_assert(virt_viewer_compare_buildid("1-1", "1-2") < 0);
+    g_assert(virt_viewer_compare_buildid("1-3", "1-2") > 0);
+    g_assert(virt_viewer_compare_buildid("2-3", "1-2") > 0);
+    g_assert(virt_viewer_compare_buildid("2-3", "3-2") < 0);
+    g_assert(virt_viewer_compare_buildid("2-3", "3-4") < 0);
+    g_assert(virt_viewer_compare_buildid("4-3", "3-4") > 0);
+
+    g_assert(virt_viewer_compare_buildid("4.0-", "3-4") > 0);
+    g_assert(virt_viewer_compare_buildid("4.0-", "3.4-4") > 0);
+    g_assert(virt_viewer_compare_buildid(".0-", "3.4-4") < 0);
+    g_assert(virt_viewer_compare_buildid("4-", "3-4") > 0);
+    g_assert(virt_viewer_compare_buildid("4-3", "3-") > 0);
+    g_assert(virt_viewer_compare_buildid("-3", "3-4") < 0);
+    g_assert(virt_viewer_compare_buildid("4-3", "-4") > 0);
+    g_assert(virt_viewer_compare_buildid("-3", "-4") < 0);
+    g_assert(virt_viewer_compare_buildid("4", "3-4") > 0);
+    g_assert(virt_viewer_compare_buildid("4-3", "3") > 0);
+    g_assert(virt_viewer_compare_buildid("3", "3-4") < 0);
+    g_assert(virt_viewer_compare_buildid("4-3", "4") > 0);
+    g_assert(virt_viewer_compare_buildid("-3", "-4") < 0);
+
+    /* These trigger runtime warnings */
+    g_assert(virt_viewer_compare_buildid("-3", "-") > 0);
+    g_assert(virt_viewer_compare_buildid("", "-") == 0);
+    g_assert(virt_viewer_compare_buildid("", "") == 0);
+    g_assert(virt_viewer_compare_buildid("", NULL) == 0);
+    g_assert(virt_viewer_compare_buildid(NULL, NULL) == 0);
+
+    return 0;
+}
