From 5c580d5964ce233f5a403533284f65cd15417917 Mon Sep 17 00:00:00 2001
From: Pavel Grunt <pgrunt@redhat.com>
Date: Sun, 14 Feb 2016 19:11:36 +0100
Subject: [PATCH] app: Compute monitor mapping only in fullscreen

(cherry picked from commit 724744ca209297322b04cd9ed11e898a3d68a281)
---
 src/virt-viewer-app.c | 26 ++++++++++++++++++++------
 1 file changed, 20 insertions(+), 6 deletions(-)

diff --git a/src/virt-viewer-app.c b/src/virt-viewer-app.c
index af344c7..b7b702a 100644
--- a/src/virt-viewer-app.c
+++ b/src/virt-viewer-app.c
@@ -458,15 +458,15 @@ virt_viewer_app_get_monitor_mapping_for_section(VirtViewerApp *self, const gchar
 }
 
 static
-void virt_viewer_app_set_uuid_string(VirtViewerApp *self, const gchar *uuid_string)
+void virt_viewer_app_apply_monitor_mapping(VirtViewerApp *self)
 {
     GHashTable *mapping = NULL;
 
-    g_debug("%s: UUID changed to %s", G_STRFUNC, uuid_string);
+    // apply mapping only in fullscreen
+    if (!virt_viewer_app_get_fullscreen(self))
+        return;
 
-    g_free(self->priv->uuid);
-    self->priv->uuid = g_strdup(uuid_string);
-    mapping = virt_viewer_app_get_monitor_mapping_for_section(self, uuid_string);
+    mapping = virt_viewer_app_get_monitor_mapping_for_section(self, self->priv->uuid);
     if (!mapping) {
         g_debug("No guest-specific fullscreen config, using fallback");
         mapping = virt_viewer_app_get_monitor_mapping_for_section(self, "fallback");
@@ -479,7 +479,7 @@ void virt_viewer_app_set_uuid_string(VirtViewerApp *self, const gchar *uuid_stri
 
     // if we're changing our initial display map, move any existing windows to
     // the appropriate monitors according to the per-vm configuration
-    if (mapping && self->priv->fullscreen) {
+    if (mapping) {
         GList *l;
         gint i = 0;
 
@@ -490,6 +490,20 @@ void virt_viewer_app_set_uuid_string(VirtViewerApp *self, const gchar *uuid_stri
     }
 }
 
+static
+void virt_viewer_app_set_uuid_string(VirtViewerApp *self, const gchar *uuid_string)
+{
+    if (g_strcmp0(self->priv->uuid, uuid_string) == 0)
+        return;
+
+    g_debug("%s: UUID changed to %s", G_STRFUNC, uuid_string);
+
+    g_free(self->priv->uuid);
+    self->priv->uuid = g_strdup(uuid_string);
+
+    virt_viewer_app_apply_monitor_mapping(self);
+}
+
 void
 virt_viewer_app_maybe_quit(VirtViewerApp *self, VirtViewerWindow *window)
 {
